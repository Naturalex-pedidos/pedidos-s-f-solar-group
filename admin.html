<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin - NATURALEX</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    
    header { 
      background: #2c5f2d; 
      color: white; 
      padding: 20px; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    header h1 { font-size: 24px; }
    
    .btn-volver {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-label { font-size: 14px; color: #666; margin-bottom: 10px; }
    .stat-value { font-size: 32px; font-weight: bold; color: #2c5f2d; }
    
    .pedido-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
      margin-bottom: 15px;
    }
    
    .pedido-info h3 { color: #2c5f2d; margin-bottom: 5px; }
    .pedido-meta { font-size: 14px; color: #666; line-height: 1.6; }
    
    .pedido-acciones {
      display: flex;
      gap: 10px;
    }
    
    .btn-eliminar {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-eliminar:hover { background: #a02834; }
    
    .productos-tabla {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .productos-tabla th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-size: 13px;
      color: #666;
      border-bottom: 2px solid #ddd;
    }
    
    .productos-tabla td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }
    
    .productos-tabla tr:hover {
      background: #fafafa;
    }
    
    .codigo-producto { 
      font-family: monospace; 
      background: #f0f0f0; 
      padding: 2px 6px; 
      border-radius: 4px;
      font-size: 12px;
    }
    
    .total-pedido {
      background: #2c5f2d;
      color: white;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      text-align: right;
    }
    
    .total-pedido .label { font-size: 14px; opacity: 0.9; }
    .total-pedido .monto { font-size: 24px; font-weight: bold; }
    
    .estado-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .estado-nuevo { background: #28a745; color: white; }
    .estado-procesando { background: #ffc107; color: #000; }
    .estado-completado { background: #17a2b8; color: white; }
    
    .vendedor-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 5px;
    }
    
    .vendedor-directo { background: #e3f2fd; color: #1976d2; }
    .vendedor-registrado { background: #f3e5f5; color: #7b1fa2; }
    
    .vacio {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      background: white;
      border-radius: 8px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üîê Panel Administrador</h1>
      <p style="font-size:12px; opacity:0.9;">NATURALEX - S&F SOLAR GROUP</p>
    </div>
    <a href="index.html" class="btn-volver">‚Üê Volver a la tienda</a>
  </header>

  <div class="container">
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Total Pedidos</div>
        <div class="stat-value" id="totalPedidos">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ventas Totales</div>
        <div class="stat-value" id="ventasTotales">S/ 0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pedidos Hoy</div>
        <div class="stat-value" id="pedidosHoy">0</div>
      </div>
    </div>

    <div id="loading" class="loading">Cargando pedidos...</div>
    <div id="listaPedidos"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfxunq2yqARtsbyavQZM8_XGC47DNNQWk",
      authDomain: "pedidos-solar-group.firebaseapp.com",
      projectId: "pedidos-solar-group",
      storageBucket: "pedidos-solar-group.firebasestorage.app",
      messagingSenderId: "205423490666",
      appId: "1:205423490666:web:50c23f6ebe6f1b95f8bc13",
      measurementId: "G-Q9VW73GGFS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function cargarPedidos() {
      const loading = document.getElementById('loading');
      const lista = document.getElementById('listaPedidos');
      
      try {
        const q = query(collection(db, 'pedidos'), orderBy('fecha', 'desc'));
        const snapshot = await getDocs(q);
        
        loading.style.display = 'none';
        
        if (snapshot.empty) {
          lista.innerHTML = '<div class="vacio">No hay pedidos registrados</div>';
          return;
        }

        let pedidos = [];
        snapshot.forEach((doc) => {
          pedidos.push({ id: doc.id, ...doc.data() });
        });

        // Actualizar estad√≠sticas
        const total = pedidos.length;
        const ventasTotal = pedidos.reduce((sum, p) => sum + (p.total || 0), 0);
        const hoy = new Date().toISOString().split('T')[0];
        const pedidosHoy = pedidos.filter(p => p.fecha.split('T')[0] === hoy).length;

        document.getElementById('totalPedidos').textContent = total;
        document.getElementById('ventasTotales').textContent = 'S/ ' + ventasTotal.toFixed(2);
        document.getElementById('pedidosHoy').textContent = pedidosHoy;

        // Renderizar pedidos
        lista.innerHTML = '';
        pedidos.forEach(pedido => {
          const div = document.createElement('div');
          div.className = 'pedido-card';
          
          const fecha = new Date(pedido.fecha);
          const fechaFormato = fecha.toLocaleDateString('es-PE', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          const estado = pedido.estado || 'nuevo';
          const estadoClass = `estado-${estado}`;
          
          // Informaci√≥n del vendedor
          const vendedor = pedido.vendedor || 'Cliente directo';
          const tipoVenta = pedido.tipoVenta || 'Cliente directo';
          const vendedorClass = tipoVenta === 'Vendedor' ? 'vendedor-registrado' : 'vendedor-directo';
          const vendedorIcon = tipoVenta === 'Vendedor' ? 'üë§' : 'üåê';

          let productosHTML = '';
          if (pedido.productos && pedido.productos.length > 0) {
            productosHTML = `
              <table class="productos-tabla">
                <thead>
                  <tr>
                    <th>C√≥digo</th>
                    <th>Producto</th>
                    <th style="text-align:center;">Cantidad</th>
                    <th style="text-align:right;">P. Unitario</th>
                    <th style="text-align:right;">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  ${pedido.productos.map(prod => `
                    <tr>
                      <td><span class="codigo-producto">${prod.codigo}</span></td>
                      <td>${prod.nombre}</td>
                      <td style="text-align:center;">${prod.cantidad}</td>
                      <td style="text-align:right;">S/ ${prod.precioUnitario.toFixed(2)}</td>
                      <td style="text-align:right;"><strong>S/ ${prod.subtotal.toFixed(2)}</strong></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }

          div.innerHTML = `
            <div class="pedido-header">
              <div class="pedido-info">
                <h3>üë§ ${pedido.cliente}</h3>
                <div class="pedido-meta">
                  üìÖ ${fechaFormato}<br>
                  üÜî ID: ${pedido.id.substring(0, 8)} ‚Ä¢ 
                  <span class="estado-badge ${estadoClass}">${estado.toUpperCase()}</span><br>
                  ${vendedorIcon} <strong>Vendedor:</strong> ${vendedor}
                  <span class="vendedor-badge ${vendedorClass}">${tipoVenta}</span>
                </div>
              </div>
              <div class="pedido-acciones">
                <button class="btn-eliminar" onclick="eliminarPedido('${pedido.id}', '${pedido.cliente}')">
                  üóëÔ∏è Eliminar
                </button>
              </div>
            </div>
            
            ${productosHTML}
            
            <div class="total-pedido">
              <div class="label">Total del pedido:</div>
              <div class="monto">S/ ${pedido.total.toFixed(2)}</div>
            </div>
          `;
          
          lista.appendChild(div);
        });

      } catch (error) {
        console.error('Error:', error);
        loading.innerHTML = '<div class="vacio">Error al cargar pedidos: ' + error.message + '</div>';
      }
    }

    window.eliminarPedido = async function(id, cliente) {
      if (!confirm(`¬øEliminar el pedido de ${cliente}?\n\nEsta acci√≥n no se puede deshacer.`)) {
        return;
      }

      try {
        await deleteDoc(doc(db, 'pedidos', id));
        alert('‚úÖ Pedido eliminado correctamente');
        cargarPedidos();
      } catch (error) {
        console.error('Error al eliminar:', error);
        alert('‚ùå Error al eliminar: ' + error.message);
      }
    };

    cargarPedidos();
    setInterval(cargarPedidos, 30000);
  </script>
</body>
</html>
