<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin - NATURALEX</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    
    header {
      background: #2c5f2d;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 24px; }
    .btn-logout {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-logout:hover { background: rgba(255,255,255,0.3); }
    
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 20px;
    }
    
    .filtros {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .filtros h3 { margin-bottom: 15px; color: #2c5f2d; }
    .filtros select, .filtros input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 10px;
      font-size: 14px;
    }
    
    .pedidos {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .pedido-item {
      border-bottom: 1px solid #eee;
      padding: 20px;
    }
    .pedido-item:last-child { border-bottom: none; }
    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .pedido-cliente { font-size: 18px; font-weight: bold; color: #2c5f2d; }
    .pedido-fecha { color: #666; font-size: 14px; }
    .pedido-estado {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .estado-pendiente { background: #fff3cd; color: #856404; }
    .estado-completado { background: #d4edda; color: #155724; }
    .estado-cancelado { background: #f8d7da; color: #721c24; }
    
    .productos-pedido {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .producto-linea {
      padding: 5px 0;
      color: #333;
      font-size: 14px;
    }
    .pedido-total {
      text-align: right;
      font-size: 20px;
      font-weight: bold;
      color: #e74c3c;
      margin-top: 10px;
    }
    .pedido-vendedor {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    
    .sin-pedidos {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 18px;
    }
    
    .btn-cambiar-estado {
      padding: 8px 15px;
      background: #2c5f2d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    .btn-cambiar-estado:hover { background: #1e4620; }
  </style>
</head>
<body>
  <header>
    <h1>üìä Panel de Administraci√≥n - NATURALEX</h1>
    <button class="btn-logout" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
  </header>

  <div class="container">
    <div class="filtros">
      <h3>Filtrar Pedidos</h3>
      <select id="filtroEstado" onchange="cargarPedidos()">
        <option value="todos">Todos los estados</option>
        <option value="pendiente">Pendientes</option>
        <option value="completado">Completados</option>
        <option value="cancelado">Cancelados</option>
      </select>
      <input type="date" id="filtroFecha" onchange="cargarPedidos()">
      <button class="btn-cambiar-estado" onclick="cargarPedidos()">üîÑ Actualizar</button>
    </div>

    <div class="pedidos" id="listaPedidos">
      <div class="sin-pedidos">Cargando pedidos...</div>
    </div>
  </div>

  <!-- Firebase Configuration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfxunq2yqARtsbyavQZM8_XGC47DNNQWk",
      authDomain: "pedidos-solar-group.firebaseapp.com",
      projectId: "pedidos-solar-group",
      storageBucket: "pedidos-solar-group.firebasestorage.app",
      messagingSenderId: "205423490666",
      appId: "1:205423490666:web:50c23f6ebe6f1b95f8bc13",
      measurementId: "G-Q9VW73GGFS"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
  </script>

  <script>
    // Verificar permisos al cargar
    function verificarPermisos() {
      const userSession = JSON.parse(localStorage.getItem('userSession'));
      
      if (!userSession) {
        alert('‚õî Debe iniciar sesi√≥n para acceder al panel de administraci√≥n');
        window.location.href = 'login.html';
        return false;
      }
      
      // Verificar que sea admin o vendedor
      if (userSession.rol !== 'admin' && userSession.rol !== 'vendedor') {
        alert('‚õî No tiene permisos para acceder a esta p√°gina');
        window.location.href = 'index.html';
        return false;
      }
      
      return true;
    }

    // Cargar pedidos desde Firebase
    async function cargarPedidos() {
      if (!verificarPermisos()) return;
      
      const lista = document.getElementById('listaPedidos');
      lista.innerHTML = '<div class="sin-pedidos">Cargando pedidos...</div>';
      
      try {
        const { getFirestore, collection, getDocs, query, orderBy } = await import('https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js');
        const { getApp } = await import('https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js');
        
        const app = getApp();
        const db = getFirestore(app);
        
        const q = query(collection(db, 'pedidos'), orderBy('fecha', 'desc'));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          lista.innerHTML = '<div class="sin-pedidos">üì¶ No hay pedidos registrados</div>';
          return;
        }
        
        const filtroEstado = document.getElementById('filtroEstado').value;
        const filtroFecha = document.getElementById('filtroFecha').value;
        
        let pedidos = [];
        querySnapshot.forEach((doc) => {
          const pedido = { id: doc.id, ...doc.data() };
          
          // Aplicar filtros
          if (filtroEstado !== 'todos' && pedido.estado !== filtroEstado) return;
          if (filtroFecha && !pedido.fecha.startsWith(filtroFecha)) return;
          
          pedidos.push(pedido);
        });
        
        if (pedidos.length === 0) {
          lista.innerHTML = '<div class="sin-pedidos">üì¶ No se encontraron pedidos con los filtros aplicados</div>';
          return;
        }
        
        lista.innerHTML = pedidos.map(pedido => {
          const fecha = new Date(pedido.fecha);
          const fechaFormato = fecha.toLocaleDateString('es-PE') + ' ' + fecha.toLocaleTimeString('es-PE');
          
          const productosHTML = pedido.productos.map(p => 
            `<div class="producto-linea">
              ${p.cantidad}x ${p.nombre} - S/ ${p.subtotal.toFixed(2)}
            </div>`
          ).join('');
          
          const estadoClass = `estado-${pedido.estado || 'pendiente'}`;
          const vendedorHTML = pedido.vendedor ? `<div class="pedido-vendedor">üë§ Vendedor: ${pedido.vendedor}</div>` : '';
          
          return `
            <div class="pedido-item">
              <div class="pedido-header">
                <div>
                  <div class="pedido-cliente">üßë ${pedido.cliente}</div>
                  <div class="pedido-fecha">üìÖ ${fechaFormato}</div>
                  ${vendedorHTML}
                </div>
                <span class="pedido-estado ${estadoClass}">${(pedido.estado || 'pendiente').toUpperCase()}</span>
              </div>
              <div class="productos-pedido">
                ${productosHTML}
              </div>
              <div class="pedido-total">Total: S/ ${pedido.total.toFixed(2)}</div>
              <div style="margin-top: 15px;">
                <button class="btn-cambiar-estado" onclick="cambiarEstado('${pedido.id}', 'completado')">‚úÖ Completar</button>
                <button class="btn-cambiar-estado" onclick="cambiarEstado('${pedido.id}', 'cancelado')" style="background: #dc3545;">‚ùå Cancelar</button>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error al cargar pedidos:', error);
        lista.innerHTML = '<div class="sin-pedidos">‚ùå Error al cargar pedidos: ' + error.message + '</div>';
      }
    }

    // Cambiar estado de pedido
    async function cambiarEstado(pedidoId, nuevoEstado) {
      if (!confirm(`¬øCambiar estado a ${nuevoEstado}?`)) return;
      
      try {
        const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js');
        const { getApp } = await import('https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js');
        
        const app = getApp();
        const db = getFirestore(app);
        
        await updateDoc(doc(db, 'pedidos', pedidoId), {
          estado: nuevoEstado
        });
        
        alert('‚úÖ Estado actualizado correctamente');
        cargarPedidos();
        
      } catch (error) {
        console.error('Error al cambiar estado:', error);
        alert('‚ùå Error al cambiar estado: ' + error.message);
      }
    }

    // Cerrar sesi√≥n
    function cerrarSesion() {
      if (confirm('¬øCerrar sesi√≥n?')) {
        localStorage.removeItem('userSession');
        window.location.href = 'login.html';
      }
    }

    // Verificar permisos y cargar pedidos al iniciar
    if (verificarPermisos()) {
      cargarPedidos();
    }
  </script>
</body>
</html>
